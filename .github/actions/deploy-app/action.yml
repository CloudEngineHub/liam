name: "Deploy App"

inputs:
  app-name:
    required: true
    type: string
  environment:
    required: true
    type: string
  vercel-project-id-key:
    required: true
    type: string
  vercel-token:
    required: true
    type: string
outputs:
  deployment-url:
    value: ${{ steps.deployment.outputs.deployment-url }}

runs:
  using: composite
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Check node_modules and public folder
      run: |
        ls -al ./node_modules
        ls -al ./public
      working-directory: '.'
    - name: Cache dependency files
      uses: actions/cache@v4
      id: cache
      with:
        path: |
          .github/workflows/vercel-deploy-erd.yml
          .github/workflows/_run_e2e_test.yml
          frontend/apps/erd-sample/**
          frontend/apps/erd-web/**
          frontend/packages/cli/**
          frontend/packages/db-structure/**
          frontend/packages/e2e/**
          frontend/packages/erd-core/**
          frontend/packages/ui/**
          pnpm-lock.yaml
    - name: Setup pnpm
      uses: ./.github/actions/pnpm-setup
    - name: Install Vercel CLI
      run: pnpm add --global vercel@latest
      shell: bash
    - name: Pull Vercel Environment Information
      run: vercel pull --yes --environment=${{ inputs.environment }} --token=${{ inputs.vercel-token }}
      shell: bash
    - name: Run prepare command
      run: pnpm build
      shell: bash
    - name: Update index.html content
      run: pnpm --filter ${{ inputs.app-name }} update_dist_content
      shell: bash
    - name: Build Project Artifacts
      run: vercel build --output .vercel/output ${{ inputs.environment == 'production' && '--prod' || '' }}
      shell: bash
    - name: Deploy Project Artifacts to Vercel
      id: deployment
      run: |
        vercel deploy --prebuilt --token=${{ inputs.vercel-token }} ${{ inputs.environment == 'production' && '--prod' || '' }} > deployment-url.txt
        echo "deployment-url=$(cat deployment-url.txt)" >> $GITHUB_OUTPUT
      shell: bash
